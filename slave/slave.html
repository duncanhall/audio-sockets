<html>
	<head>
	<script src="/socket.io/socket.io.js"></script>
	<script src="audiosynth/audiosynth.js"></script>
	<script src="js/raf.js"></script>
	<script src="js/Class.js"></script>
	<script src="js/Instrument.js"></script>
	<script src="js/Controller.js"></script>
	<script>

	var output = null;
	var socket = null;
	var colors = [];
	var timer;
	var active = 0;

	var controller = new Controller();

	var minX = 0;
	var maxX = 0;
	var minY = 0;
	var maxY = 0;		


	function onload()
	{     
		output = document.getElementById('output');
		socket = io.connect('http://22.155.0.3:8000');

		setBounds();
		window.onresize = setBounds;

		socket.on("connect", function() {
			socket.emit("id", "slave");
		});

		socket.on("cmd-client", function(data) {

			var id = data.id;
			var cmd = data.cmd;

			switch(cmd)
			{

				case "hs":
					
					instrument = controller.addClient(output, Bass, id);
					instrument.setColor(data.color);
					colors[id] = data.color;
					break;

				case "down":

					if (active < 1)
						timer = setInterval(stepAudio, 80);

					active++;
					controller.execute(id, Controller.START);
					break;

				case "up":
					active--;
					if (active < 1)
						clearInterval(timer);
					
					controller.execute(id, Controller.STOP);
					break;					

				case "disconnect":
					controller.destroyClient(id);
					break;
			}
		});

		animate();
	}    	

	function draw() {

		var c = null;
		for (var i in controller.clients) {

			c = controller.clients[i];
			if (c.active)
			{
				c.step();

				if (c.x <= minX || c.x >= maxX)
					c.bounce(-1, 1);
				if (c.y <= minY || c.y >= maxY)
					c.bounce(1, -1);

				c.element.style.margin = c.y + 'px 0 0 ' + c.x  + 'px';
			}
		}
	}

	function stepAudio () {

		var c = null;
		for (var i in controller.clients) {

			c = controller.clients[i];
			if (c.active)
				c.playNextNote();
		}
	}

	function animate() {

	    requestAnimationFrame( animate );
	    draw();
	}

	function setBounds(event) {

		minX = ((window.innerWidth / 2) * -1);
		maxX = (window.innerWidth / 2) - 50;
		minY = ((window.innerHeight / 2 ) * -1) + 50;
		maxY = (window.innerHeight / 2);		
	}

	</script>
	<link rel="stylesheet" href="css/slave.css" />

	</head>
	<body onload="onload();">
			<div id="output"></div>
	</body>
</html>
