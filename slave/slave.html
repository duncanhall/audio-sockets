<html>
	<head>
	<script src="/socket.io/socket.io.js"></script>
	<script src="audiosynth/audiosynth.js"></script>
	<script src="js/raf.js"></script>
	<script src="js/Class.js"></script>
	<script src="js/Instrument.js"></script>
	<script src="js/Controller.js"></script>
	<script>

	var output = null;
	var socket = null;
	var reactor = null;
	var instruments = [Bass, High, Bass];
	var colors = [];
	var numInstruments = 0;
	var timer;
	var active = 0;

	var controller = new Controller();

	function onload()
	{     
		output = document.getElementById('output');
		socket = io.connect('http://22.155.0.3:8000');

		window.onresize = function (event)
		{
			var bounds = getBounds();
			for (var i in controller.clients) {

				setBounds(controller.clients[i], bounds);
			}			
		}

		socket.on("connect", function() {
			socket.emit("id", "slave");
		});

		socket.on("cmd-client", function(data) {

			var id = data.id;
			var cmd = data.cmd;

			switch(cmd)
			{

				case "hs":
					
					instrument = createInstrument(id);
					instrument.setColor(data.color);
					instrument.setColor(data.color);
					setBounds(instrument, getBounds());
					colors[id] = data.color;
					break;

				case "down":

					if (active < 1)
						timer = setInterval(stepAudio, 80);

					active++;
					controller.execute(id, Controller.START);
					break;

				case "up":
					active--;
					if (active < 1)
						clearInterval(timer);
					
					controller.execute(id, Controller.STOP);
					break;					

				case "disconnect":
					destroyClient(id);
					break;
			}
		});

		animate();
	}    

	function destroyClient(id) {

		output.removeChild(controller.getClientById(id).element); //Todo: not this
		controller.destroyClient(id);
		updateOutput();
	}

	function createInstrument (id) {

		var instrument = controller.addClient(instruments[numInstruments], id);
		output.appendChild(instrument.element);
		updateOutput();

		return instrument;
	}	

	function updateOutput () {

		output.style.width = String(numInstruments * 210) + 'px';
		output.style.marginLeft = '-' + String(numInstruments * 100) + 'px';		
	}

	function draw() {

		var c = null;
		for (var i in controller.clients) {

			c = controller.clients[i];
			if (c.active)
				c.step();
		}
	}

	function stepAudio () {

		var c = null;
		for (var i in controller.clients) {

			c = controller.clients[i];
			if (c.active)
				c.playNextNote();
		}
	}

	function animate() {

	    requestAnimationFrame( animate );
	    draw();
	}

	function getBounds() {

		var left = ((window.innerWidth / 2) * -1) + 100;
		var right = (window.innerWidth / 2);
		var top = ((window.innerHeight / 2 ) * -1) + 50;
		var bottom = (window.innerHeight / 2) + 20;		

		return {x:left, w:right, y:top, h:bottom};
	}

	function setBounds (instrument, bounds) {

		instrument.setBounds(bounds.y, bounds.w, bounds.h, bounds.x);
	}

	</script>
	<link rel="stylesheet" href="css/slave.css" />

	</head>
	<body onload="onload();">
			<div id="output"></div>
	</body>
</html>
