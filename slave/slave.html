<html>
	<head>
	<script src="/socket.io/socket.io.js"></script>
	<script src="audiosynth/audiosynth.js"></script>
	<script src="js/raf.js"></script>
	<script src="js/Class.js"></script>
	<script src="js/Instrument.js"></script>
	<script>

	var output = null;
	var socket = null;
	var reactor = null;
	var instruments = [Bass, High, Bass];
	var colors = [];
	var numInstruments = 0;

	function onload()
	{     
		output = document.getElementById('output');
		socket = io.connect('http://22.155.0.3:8000');
		clients = [];

		window.onresize = function (event)
		{
			var bounds = getBounds();
			for (var i in clients) {

				setBounds(clients[i], bounds);
			}			
		}

		socket.on("connect", function() {
			socket.emit("id", "slave");
		});

		socket.on("cmd-client", function(data) {

			var id = data.id;
			var cmd = data.cmd;
			var instrument = getClientByID(id);

			switch(cmd)
			{

				case "hs":
					instrument.setColor(data.color);
					colors[id] = data.color;
					break;

				case "down":
					instrument.start();
					break;

				case "up":
					instrument.stop();
					break;					

				case "disconnect":
					destroyClient(id);
					break;
			}
		});

		animate();
	}    

	function getClientByID (id) {

		var instrument = clients[id];

		if (instrument == null) {
			instrument = createInstrument();

			setBounds(instrument, getBounds());

			if (colors[id] != null)
				instrument.setColor(colors[id]);

			clients[id] = instrument;
		}

		return instrument;
	}

	function destroyClient(id) {

		var instrument = clients[id];

		if (instrument != null) {
			numInstruments--;
			output.removeChild(instrument.element);
			instrument.destroy();
			updateOutput();
		}

		clients[id] = null;
		delete clients[id];
	}

	function createInstrument () {

		var instrument = new instruments[numInstruments]();

		numInstruments++;
		output.appendChild(instrument.element);
		updateOutput();

		return instrument;
	}	

	function updateOutput () {

		output.style.width = String(numInstruments * 210) + 'px';
		output.style.marginLeft = '-' + String(numInstruments * 100) + 'px';		
	}

	function draw() {

		var c = null;
		for (var i in clients) {

			c = clients[i];
			if (c.active)
				c.step();
		}
	}

	function animate() {

	    requestAnimationFrame( animate );
	    draw();
	}

	function getBounds() {

		var left = ((window.innerWidth / 2) * -1) + 100;
		var right = (window.innerWidth / 2) + 100;
		var top = ((window.innerHeight / 2 ) * -1) + 50;
		var bottom = (window.innerHeight / 2) + 20;		

		return {x:left, w:right, y:top, h:bottom};
	}

	function setBounds (instrument, bounds) {

		instrument.setBounds(bounds.y, bounds.w, bounds.h, bounds.x);
	}

	</script>
	<link rel="stylesheet" href="css/slave.css" />

	</head>
	<body onload="onload();">
			<div id="output"></div>
	</body>
</html>
